import React, { useState, useCallback, useEffect } from 'react';

// Utilit√°rios para c√°lculos (fora do componente)
const calculateAge = (birthDate, surgeryDate) => {
  if (!birthDate || !surgeryDate) return null;
  const birth = new Date(birthDate);
  const surgery = new Date(surgeryDate);
  let age = surgery.getFullYear() - birth.getFullYear();
  const monthDiff = surgery.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && surgery.getDate() < birth.getDate())) {
    age--;
  }
  return age;
};

const getSuggestedTOT = (age, sex) => {
  if (age === null) return '';
  if (age === 0) return '3.0';
  if (age < 12) return ((age / 4) + 3.5).toFixed(1);
  return sex?.toUpperCase() === 'F' ? '7.0' : '7.5';
};

const isPediatric = (age) => age !== null && age < 12;

// Geradores de texto (fun√ß√µes puras)
const generateMonitoringText = (monitoring) => {
  const items = [];
  if (monitoring.cardioscopia) items.push('cardioscopia');
  if (monitoring.oximetria) items.push('oximetria');
  if (monitoring.pani) items.push('PANI');
  if (monitoring.capnografia) items.push('capnografia');
  if (monitoring.pai) items.push('PAI');
  if (monitoring.pvc) items.push('PVC');
  if (monitoring.termometro) items.push('term√¥metro');
  if (monitoring.bis) items.push('BIS');
  if (monitoring.tof) items.push('TOF');
  
  if (items.length === 0) return '';
  return `Monitoriza√ß√£o: ${items.join(', ')}.`;
};

const generateAdmissionText = (admission, isChild) => {
  const parts = [];
  
  const ventMap = {
    espontanea: 'ventila√ß√£o espont√¢nea',
    vm_invasiva: 'ventila√ß√£o mec√¢nica invasiva', 
    vm_nao_invasiva: 'ventila√ß√£o mec√¢nica n√£o invasiva'
  };
  
  const oxygenMap = {
    ar_ambiente: 'ar ambiente',
    cateter_2l: 'O‚ÇÇ por cateter nasal 2 L/min',
    mascara_5l: 'O‚ÇÇ por m√°scara facial 5 L/min'
  };
  
  const hemoMap = {
    estavel: 'hemodinamicamente est√°vel',
    instavel: 'hemodinamicamente inst√°vel'
  };
  
  if (admission.ventilatory) parts.push(ventMap[admission.ventilatory]);
  if (admission.oxygen) parts.push(oxygenMap[admission.oxygen]);
  if (admission.hemodynamic) parts.push(hemoMap[admission.hemodynamic]);
  
  if (parts.length === 0) return '';
  
  const base = isChild ? 'Paciente pedi√°trico admitido em sala cir√∫rgica' : 'Paciente admitido em sala cir√∫rgica';
  return `${base}, ${parts.join(', ')}.`;
};

const generateTechniqueText = (technique) => {
  const texts = [];
  
  if (technique.geral) {
    const tot = technique.totNumber || '7.0';
    const cormack = technique.cormack || 'I';
    const fixacao = technique.fixacao || '21';
    
    texts.push(
      `Indu√ß√£o anest√©sica: a) Desnitrogeniza√ß√£o com O‚ÇÇ 100%; b) Drogas utilizadas conforme se√ß√£o de medicamentos; c) Intuba√ß√£o orotraqueal com TOT n¬∞ ${tot} sob laringoscopia direta (Cormack-Lehane ${cormack}); d) Tubo fixado a ${fixacao} cm na comissura labial.\nManuten√ß√£o com drogas descritas em se√ß√£o de medica√ß√µes, sob ventila√ß√£o mec√¢nica. Par√¢metros ventilat√≥rios e monitora√ß√£o cont√≠nua mantidos; prote√ß√£o ocular.`
    );
  }
  
  if (technique.raquianestesia) {
    texts.push(
      `Raquianestesia: a) Posicionamento em dec√∫bito lateral; b) Assepsia e antissepsia; c) Pun√ß√£o √∫nica no espa√ßo subaracn√≥ide, LCR l√≠mpido; d) Medica√ß√µes conforme se√ß√£o de medicamentos.\nTeste de bloqueio com est√≠mulos t√©rmicos e motores.`
    );
  }
  
  if (technique.sedacao) {
    texts.push(
      `Seda√ß√£o consciente com medica√ß√µes descritas na se√ß√£o de medicamentos.\nSuplementa O‚ÇÇ via cateter nasal.`
    );
  }
  
  return texts.join('\n\n');
};

const generateCompletionText = (completion) => {
  const parts = [];
  
  if (completion.positionReview === true) {
    parts.push('Revis√£o de posicionamento realizada.');
  }
  
  if (completion.standardEnd === true) {
    parts.push('Ao t√©rmino da cirurgia, paciente com respira√ß√£o espont√¢nea, obedecendo comandos, boa mec√¢nica ventilat√≥ria e oximetria est√°vel.');
  }
  
  if (completion.destination) {
    const destination = completion.destination === 'uti' ? 'UTI' : 'RPA';
    parts.push(`Encaminhado √† ${destination} em boas condi√ß√µes cl√≠nicas.`);
  }
  
  return parts.join(' ');
};

// Componente de bot√£o salvar
const SaveButton = ({ section, hasChanges, isSaving, onSave, everSaved }) => {
  if (isSaving) {
    return (
      <button 
        disabled 
        className="px-3 py-1 bg-gray-400 text-white rounded text-sm flex items-center gap-1"
      >
        <div className="w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"></div>
        Salvando...
      </button>
    );
  }
  
  if (!hasChanges && everSaved) {
    return (
      <button 
        disabled 
        className="px-3 py-1 bg-green-500 text-white rounded text-sm"
      >
        ‚úì Salvo
      </button>
    );
  }
  
  if (hasChanges) {
    return (
      <button 
        onClick={onSave}
        className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
      >
        üíæ Salvar {section}
      </button>
    );
  }
  
  // Se√ß√£o nunca tocada/salva
  return (
    <button 
      disabled 
      className="px-3 py-1 bg-gray-300 text-gray-500 rounded text-sm"
    >
      Salvar {section}
    </button>
  );
};

// Componente principal
const AnesthesiaDescription = ({ patient, surgery, anesthesia, onUpdate }) => {
  // Estados separados para cada se√ß√£o
  const [data, setData] = useState({
    monitoring: {},
    admission: {},
    technique: {},
    completion: {}
  });
  
  // Estados salvos (do Firestore)
  const [savedData, setSavedData] = useState({
    monitoring: {},
    admission: {},
    technique: {},
    completion: {}
  });
  
  // Estados de salvamento para cada se√ß√£o
  const [savingStatus, setSavingStatus] = useState({
    monitoring: false,
    admission: false,
    technique: false,
    completion: false
  });
  
  // Estado para rastrear se√ß√µes que j√° foram salvas pelo menos uma vez
  const [everSaved, setEverSaved] = useState({
    monitoring: false,
    admission: false,
    technique: false,
    completion: false
  });
  
  const [copied, setCopied] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  
  // Carrega dados existentes do Firestore
  useEffect(() => {
    if (anesthesia?.anesthesiaDescription) {
      console.log('üîÑ Carregando dados do Firestore:', anesthesia.anesthesiaDescription);
      const firestoreData = {
        monitoring: anesthesia.anesthesiaDescription.monitoring || {},
        admission: anesthesia.anesthesiaDescription.admission || {},
        technique: anesthesia.anesthesiaDescription.technique || {},
        completion: anesthesia.anesthesiaDescription.completion || {}
      };
      setData(firestoreData);
      setSavedData(firestoreData);
      
      // Marca se√ß√µes com dados como "j√° salvas pelo menos uma vez"
      setEverSaved({
        monitoring: Object.keys(firestoreData.monitoring).length > 0,
        admission: Object.keys(firestoreData.admission).length > 0,
        technique: Object.keys(firestoreData.technique).length > 0,
        completion: Object.keys(firestoreData.completion).length > 0
      });
    }
    setIsInitialized(true);
  }, [anesthesia?.anesthesiaDescription]);
  
  // Dados derivados
  const age = calculateAge(patient?.patientBirthDate, surgery?.surgeryDate);
  const isChild = isPediatric(age);
  const suggestedTOT = getSuggestedTOT(age, patient?.patientSex);
  
  // Verificar se h√° mudan√ßas n√£o salvas por se√ß√£o
  const hasUnsavedChanges = useCallback((section) => {
    return JSON.stringify(data[section]) !== JSON.stringify(savedData[section]);
  }, [data, savedData]);
  
  // Handler para atualizar dados localmente (sem salvar)
  const updateSection = useCallback((section, field, value) => {
    setData(prev => {
      const newData = {
        ...prev,
        [section]: { ...prev[section], [field]: value }
      };
      
      // Auto-sugest√£o para TOT
      if (section === 'technique' && field === 'geral' && value && !prev.technique.totNumber) {
        newData.technique.totNumber = suggestedTOT;
        newData.technique.fixacao = ((parseFloat(suggestedTOT) || 7) * 3).toFixed(0);
      }
      
      return newData;
    });
  }, [suggestedTOT]);
  
  // Handler para salvar se√ß√£o espec√≠fica
  const saveSection = useCallback(async (section) => {
    if (!hasUnsavedChanges(section) || !onUpdate) return;
    
    setSavingStatus(prev => ({ ...prev, [section]: true }));
    
    try {
      // Salva APENAS a se√ß√£o espec√≠fica
      const sectionUpdate = {
        [`anesthesiaDescription.${section}`]: data[section]
      };
      
      console.log(`üíæ Salvando se√ß√£o ${section}:`, sectionUpdate);
      
      await onUpdate(sectionUpdate);
      
      // Atualiza dados salvos
      setSavedData(prev => ({
        ...prev,
        [section]: data[section]
      }));
      
      // Marca como "j√° salva pelo menos uma vez"
      setEverSaved(prev => ({
        ...prev,
        [section]: true
      }));
      
    } catch (error) {
      console.error(`‚ùå Erro ao salvar ${section}:`, error);
      alert(`Erro ao salvar ${section}. Tente novamente.`);
    } finally {
      setSavingStatus(prev => ({ ...prev, [section]: false }));
    }
  }, [data, savedData, hasUnsavedChanges, onUpdate]);
  
  // Gera√ß√£o do texto completo (usa dados salvos + mudan√ßas locais)
  const generateFullText = useCallback(() => {
    const sections = [
      generateMonitoringText(data.monitoring),
      generateAdmissionText(data.admission, isChild),
      generateTechniqueText(data.technique),
      generateCompletionText(data.completion)
    ].filter(Boolean);
    
    return sections.join('\n\n') || 'Complete e salve as se√ß√µes para gerar a descri√ß√£o...';
  }, [data, isChild]);
  
  // Copy handler
  const handleCopy = useCallback(async () => {
    try {
      await navigator.clipboard.writeText(generateFullText());
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Erro ao copiar:', err);
    }
  }, [generateFullText]);
  
  // Verificar se h√° mudan√ßas n√£o salvas em qualquer se√ß√£o
  const hasAnyUnsavedChanges = ['monitoring', 'admission', 'technique', 'completion']
    .some(section => hasUnsavedChanges(section));
  
  // Loading state
  if (!isInitialized) {
    return (
      <div className="p-6 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
          <p className="text-gray-600">Carregando dados...</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="p-6 space-y-6 max-w-4xl mx-auto">
      {/* Aviso de mudan√ßas n√£o salvas */}
      {hasAnyUnsavedChanges && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          <p className="text-sm text-yellow-800">
            ‚ö†Ô∏è Voc√™ tem altera√ß√µes n√£o salvas. Salve cada se√ß√£o antes de sair da p√°gina.
          </p>
        </div>
      )}
      
      {/* 1. MONITORIZA√á√ÉO */}
      <div className="bg-white border rounded-lg p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-900">1. Monitoriza√ß√£o</h3>
          <SaveButton
            section="Monitoriza√ß√£o"
            hasChanges={hasUnsavedChanges('monitoring')}
            isSaving={savingStatus.monitoring}
            onSave={() => saveSection('monitoring')}
            everSaved={everSaved.monitoring}
          />
        </div>
        
        <div className="grid grid-cols-3 gap-3 mb-4">
          {[
            { key: 'cardioscopia', label: 'Cardioscopia' },
            { key: 'oximetria', label: 'Oximetria' },
            { key: 'pani', label: 'PANI' },
            { key: 'capnografia', label: 'Capnografia' },
            { key: 'pai', label: 'PAI' },
            { key: 'pvc', label: 'PVC' },
            { key: 'termometro', label: 'Term√¥metro' },
            { key: 'bis', label: 'BIS' },
            { key: 'tof', label: 'TOF' }
          ].map(option => (
            <label key={option.key} className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={data.monitoring[option.key] || false}
                onChange={(e) => updateSection('monitoring', option.key, e.target.checked)}
                className="rounded"
              />
              <span className="text-sm">{option.label}</span>
            </label>
          ))}
        </div>
        
        <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded">
          {generateMonitoringText(data.monitoring) || 'Selecione os monitores utilizados...'}
        </div>
      </div>

      {/* 2. ADMISS√ÉO */}
      <div className="bg-white border rounded-lg p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-900">2. Condi√ß√µes de Admiss√£o</h3>
          <SaveButton
            section="Admiss√£o"
            hasChanges={hasUnsavedChanges('admission')}
            isSaving={savingStatus.admission}
            onSave={() => saveSection('admission')}
            everSaved={everSaved.admission}
          />
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-medium mb-1">Ventila√ß√£o</label>
            <select 
              value={data.admission.ventilatory || ''} 
              onChange={(e) => updateSection('admission', 'ventilatory', e.target.value)}
              className="w-full border rounded px-3 py-2 text-sm"
            >
              <option value="">Selecione...</option>
              <option value="espontanea">Espont√¢nea</option>
              <option value="vm_invasiva">VM Invasiva</option>
              <option value="vm_nao_invasiva">VM N√£o Invasiva</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">Oxigena√ß√£o</label>
            <select 
              value={data.admission.oxygen || ''} 
              onChange={(e) => updateSection('admission', 'oxygen', e.target.value)}
              className="w-full border rounded px-3 py-2 text-sm"
            >
              <option value="">Selecione...</option>
              <option value="ar_ambiente">Ar ambiente</option>
              <option value="cateter_2l">Cateter O‚ÇÇ 2L/min</option>
              <option value="mascara_5l">M√°scara O‚ÇÇ 5L/min</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">Hemodin√¢mica</label>
            <select 
              value={data.admission.hemodynamic || ''} 
              onChange={(e) => updateSection('admission', 'hemodynamic', e.target.value)}
              className="w-full border rounded px-3 py-2 text-sm"
            >
              <option value="">Selecione...</option>
              <option value="estavel">Est√°vel</option>
              <option value="instavel">Inst√°vel</option>
            </select>
          </div>
        </div>
        
        <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded">
          {generateAdmissionText(data.admission, isChild) || 'Selecione as condi√ß√µes de admiss√£o...'}
        </div>
      </div>

      {/* 3. T√âCNICA ANEST√âSICA */}
      <div className="bg-white border rounded-lg p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-900">3. T√©cnica Anest√©sica</h3>
          <SaveButton
            section="T√©cnica"
            hasChanges={hasUnsavedChanges('technique')}
            isSaving={savingStatus.technique}
            onSave={() => saveSection('technique')}
            everSaved={everSaved.technique}
          />
        </div>
        
        <div className="space-y-4">
          {/* Anestesia Geral */}
          <div>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={data.technique.geral || false}
                onChange={(e) => updateSection('technique', 'geral', e.target.checked)}
                className="rounded"
              />
              <span className="font-medium">Anestesia Geral</span>
            </label>
            
            {data.technique.geral && (
              <div className="ml-6 mt-2 grid grid-cols-3 gap-3">
                <div>
                  <label className="block text-xs text-gray-600 mb-1">TOT n¬∫</label>
                  <input
                    type="text"
                    value={data.technique.totNumber || ''}
                    onChange={(e) => updateSection('technique', 'totNumber', e.target.value)}
                    placeholder={suggestedTOT}
                    className="w-full border rounded px-2 py-1 text-sm"
                  />
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Cormack-Lehane</label>
                  <select 
                    value={data.technique.cormack || ''} 
                    onChange={(e) => updateSection('technique', 'cormack', e.target.value)}
                    className="w-full border rounded px-2 py-1 text-sm"
                  >
                    <option value="">-</option>
                    <option value="I">I</option>
                    <option value="II">II</option>
                    <option value="III">III</option>
                    <option value="IV">IV</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs text-gray-600 mb-1">Fixa√ß√£o (cm)</label>
                  <input
                    type="text"
                    value={data.technique.fixacao || ''}
                    onChange={(e) => updateSection('technique', 'fixacao', e.target.value)}
                    className="w-full border rounded px-2 py-1 text-sm"
                  />
                </div>
              </div>
            )}
          </div>
          
          {/* Outras t√©cnicas */}
          <div className="grid grid-cols-2 gap-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={data.technique.raquianestesia || false}
                onChange={(e) => updateSection('technique', 'raquianestesia', e.target.checked)}
                className="rounded"
              />
              <span>Raquianestesia</span>
            </label>
            
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={data.technique.sedacao || false}
                onChange={(e) => updateSection('technique', 'sedacao', e.target.checked)}
                className="rounded"
              />
              <span>Seda√ß√£o</span>
            </label>
          </div>
        </div>
        
        <div className="mt-4 text-sm text-gray-600 bg-gray-50 p-3 rounded">
          {generateTechniqueText(data.technique) || 'Selecione a t√©cnica anest√©sica...'}
        </div>
      </div>

      {/* 4. FINALIZA√á√ÉO */}
      <div className="bg-white border rounded-lg p-4">
        <div className="flex justify-between items-center mb-3">
          <h3 className="font-semibold text-gray-900">4. Finaliza√ß√£o</h3>
          <SaveButton
            section="Finaliza√ß√£o"
            hasChanges={hasUnsavedChanges('completion')}
            isSaving={savingStatus.completion}
            onSave={() => saveSection('completion')}
            everSaved={everSaved.completion}
          />
        </div>
        
        <div className="space-y-3 mb-4">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={data.completion.positionReview === true}
              onChange={(e) => updateSection('completion', 'positionReview', e.target.checked)}
              className="rounded"
            />
            <span className="text-sm">Revis√£o de posicionamento realizada</span>
          </label>
          
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={data.completion.standardEnd === true}
              onChange={(e) => updateSection('completion', 'standardEnd', e.target.checked)}
              className="rounded"
            />
            <span className="text-sm">Finaliza√ß√£o padr√£o (boa mec√¢nica ventilat√≥ria, etc.)</span>
          </label>
          
          <div>
            <label className="block text-sm font-medium mb-1">Encaminhado para:</label>
            <div className="flex gap-4">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="destination"
                  value="rpa"
                  checked={data.completion.destination === 'rpa'}
                  onChange={(e) => updateSection('completion', 'destination', e.target.value)}
                  className="rounded"
                />
                <span className="text-sm">RPA</span>
              </label>
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  name="destination"
                  value="uti"
                  checked={data.completion.destination === 'uti'}
                  onChange={(e) => updateSection('completion', 'destination', e.target.value)}
                  className="rounded"
                />
                <span className="text-sm">UTI</span>
              </label>
            </div>
          </div>
        </div>
        
        <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded">
          {generateCompletionText(data.completion)}
        </div>
      </div>

      {/* DESCRI√á√ÉO FINAL */}
      <div className="bg-white border rounded-lg p-4">
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-semibold text-gray-900">Descri√ß√£o Anest√©sica Final</h3>
          <button
            onClick={handleCopy}
            className={`px-4 py-2 rounded text-sm font-medium transition-colors ${
              copied 
                ? 'bg-green-100 text-green-700' 
                : 'bg-blue-600 text-white hover:bg-blue-700'
            }`}
          >
            {copied ? '‚úì Copiado!' : 'üìã Copiar'}
          </button>
        </div>
        
        <div className="bg-gray-50 p-4 rounded text-sm whitespace-pre-line leading-relaxed border">
          {generateFullText()}
        </div>
        
        <div className="mt-2 text-xs text-gray-500 flex justify-between">
          <span>
            {isChild ? 'üë∂ Paciente pedi√°trico' : 'üë§ Paciente adulto'}
            {age !== null && ` ‚Ä¢ ${age} anos`}
            {patient?.patientSex && ` ‚Ä¢ ${patient.patientSex === 'M' ? 'Masculino' : 'Feminino'}`}
          </span>
          <span>{generateFullText().length} caracteres</span>
        </div>
      </div>
    </div>
  );
};

export default AnesthesiaDescription;